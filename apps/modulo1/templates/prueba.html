{% extends 'base.html' %}
{% load static %}
{% now "U" as ts %}

{% block navegacion %}
{% include 'navegacion.html' %}
{% endblock %}

{% block contenido %}

<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî Contenedor ‚Äî‚Äî‚Äî‚Äî‚Äî */
.factura-container{
  width: min(100%, 900px);
  margin: 20px auto;
  border: 1px solid #000;
  background:#fff;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
  /* padding fluido */
  padding: clamp(12px, 2.2vw, 24px);
}

/* ‚ö†Ô∏è QUITAR/ANULAR esta regla que te rompe el layout m√≥vil:
.factura-container > div { display:flex; justify-content:space-between; ... }
*/
.factura-container > div{ display:block; } /* anula la anterior si no pod√©s borrarla */

/* ‚Äî‚Äî‚Äî‚Äî‚Äî Encabezado ‚Äî‚Äî‚Äî‚Äî‚Äî */
.encabezado-factura{
  /* GRID para controlar orden en desktop/m√≥vil sin cambiar el HTML */
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  grid-template-areas: "titulo logo datos";
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
  padding: 16px;
  border-radius: 10px;

  /* fondo suave (tu imagen tiled) */
  background-image: url('{% static "img/Logos/basketball.png" %}');
  background-repeat: repeat;
  background-size: contain;
}

.encabezado-factura .titulo{ grid-area: titulo; line-height: 1.1; }
.encabezado-factura .datos{  grid-area: datos;  line-height: 1.8; text-align: right; }
.encabezado-factura .logo{   grid-area: logo;  display:grid; place-items:center; }

.encabezado-factura .titulo h5{
  margin: 0 0 6px 0;
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  font-size: clamp(22px, 4.2vw, 36px); /* fluido: 22‚Äì36 */
}

.encabezado-factura .titulo p,
.encabezado-factura .datos p{
  margin: 0;
  font-size: clamp(12px, 1.9vw, 14px);
  color:#333;
}

.encabezado-factura .logo img{
  height: clamp(72px, 14vw, 110px);
  width:  clamp(72px, 14vw, 110px);
  object-fit: cover;
  border-radius: 30%;
  border: 2px solid #e5e7eb;
}

/* ‚Äî‚Äî‚Äî‚Äî M√ìVIL ‚Äî‚Äî‚Äî‚Äî */
@media (max-width: 768px){
  .encabezado-factura{
    grid-template-columns: 1fr;
    grid-template-areas:
      "titulo"
      "datos"
      "logo";
    text-align: center;
  }
  .encabezado-factura .datos{ text-align: center; }
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî Tabla responsive ‚Äî‚Äî‚Äî‚Äî‚Äî */
.table{
  width:100%;
  border-collapse: collapse;
  font-size: 14px;
  table-layout: fixed;      /* evita que ‚Äúsalte‚Äù */
  word-wrap: break-word;
}
.table th, .table td{
  padding: 10px;
  border: 1px solid #ddd;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.table th{ background:#f4f4f4; font-weight: 600; }

/* Wrapper para scroll horizontal en m√≥vil */
.table-responsive{
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Compresi√≥n progresiva en pantallas chicas */
@media (max-width:768px){
  .table th, .table td{ font-size: 11px; padding: 6px; }
}
@media (max-width:480px){
  .table{ font-size: 10px; }
  .table th, .table td{ font-size:10px; padding:4px; }
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî Botones ‚Äî‚Äî‚Äî‚Äî‚Äî */
.btn{ padding: 8px 12px; font-size: 14px; border:none; border-radius: 6px; color:#fff; cursor:pointer; }
.btn-primary{ background:#007bff; } .btn-primary:hover{ background:#0056b3; }
.btn-success{ background:#28a745; } .btn-success:hover{ background:#218838; }
.btn-danger { background:#dc3545; } .btn-danger:hover { background:#c82333; }

@media (max-width:768px){
  .btn{ font-size:12px; padding:6px 10px; }
  .btn-aceptar{ width:100%; max-width: 120px; }
}
@media (max-width:480px){
  .btn{ font-size:11px; padding:5px 8px; }
  .btn-aceptar{ max-width: 100px; }
}
</style>



<div class="table-responsive">
    <!-- Encabezado de la factura -->
    <div class="encabezado-factura">
        <div class="titulo">
            <h5 style="margin-bottom:10px;font-size:48px;font-family:'Poppins',sans-serif;">Factura</h5>
            <p style="margin:0;">Factura N¬∫: {{ numero_factura }}</p>
        </div>

        <div class="datos">
            <p style="margin:0;">Fecha: {{ fecha_actual }}</p>
            <p style="margin:0;">Hora: {{ hora }}</p>
            <p style="margin:0;">Vendedor: {{ user.first_name}} {{ user.last_name }}</p>
        </div>

       <div class="logo">
        <img src="{% static 'img/atenealogo1.png' %}?v={{ ts }}" alt="Logo"
            style="height:100px;width:100px;object-fit:cover;border-radius:30%;">
        </div>
       </div>
      <hr>
   
    <!-- Buscar Clientes------------------------------------------------------- -->
    <!-- === Cliente: Autocomplete profesional === -->
    <style>
        .cliente-autocomplete .dropdown-menu{
            display:block;           /* lo controlamos por .show */
            visibility:hidden;
            opacity:0;
            transform: translateY(-4px);
            transition: opacity .15s ease, transform .15s ease, visibility .15s;
        }
        .cliente-autocomplete .dropdown-menu.show{
            visibility:visible;
            opacity:1;
            transform: translateY(0);
        }
        .cliente-autocomplete .dropdown-item small{
            color:#6c757d;
        }
        .cliente-autocomplete .kbd{
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size:.75rem;
            border:1px solid #dee2e6;
            border-bottom-width:2px;
            padding:0 .35rem;
            border-radius:.25rem;
            background:#f8f9fa;
            color:#495057;
        }
    </style>

    <style>
        /* Ajust√° este valor a gusto */
        :root{ --input-std-max: 60ch; }  /* ‚âà 60 caracteres visibles */

        /* El input y su dropdown tomar√°n este ancho */
        .input-wrap-std{
            width:100%;
            max-width: var(--input-std-max);
        }
        @media (max-width:576px){
            .input-wrap-std{ max-width:100%; }  /* en m√≥vil ocupan todo */
        }

        /* Asegura que el dropdown coincida con el ancho del wrapper */
        .input-wrap-std .dropdown-menu,
        .input-wrap-std .list-group{ width:100%; }
    </style>

            <div class="cliente-autocomplete mb-3">
            <form id="form_cliente" method="POST" class="row g-2 align-items-center">
                {% csrf_token %}

                <!-- Label alineado a la izquierda (no salta de l√≠nea) -->
                <label for="nombre_apellido_cliente"
                    class="col-auto col-form-label fw-semibold mb-0 inline-label">
                Cliente
                </label>

                <!-- Input ocupa el resto; contenedor relativo para el dropdown -->
                <div class="col position-relative input-wrap-std">
                <input
                    type="text"
                    id="nombre_apellido_cliente"
                    name="nombre_apellido_cliente"
                    class="form-control form-control-sm"
                    placeholder="Buscar por nombre o DNI‚Ä¶"
                    autocomplete="off"
                    
                    aria-describedby="cliente_help"
                    aria-expanded="false"
                    aria-controls="sugerencias_cliente"
                />

                <!-- Sugerencias pegado al input -->
                <div id="sugerencias_cliente"
                    class="dropdown-menu w-100 shadow"
                    role="listbox"
                    style="max-height:240px; overflow:auto;">
                    <!-- contenido din√°mico -->
                </div>
                
                </div>
                <input type="hidden" id="dni_cliente_hidden" name="dni_cliente" value="{{ dni_cliente }}">
            </form>
            </div>

    <script>
        (function(){
        const $input   = document.getElementById('nombre_apellido_cliente');
        const $dni     = document.getElementById('dni_cliente_hidden');
        const $menu    = document.getElementById('sugerencias_cliente');
        const $form    = document.getElementById('form_cliente');

        let items = [];       // resultados actuales
        let activeIndex = -1; // √≠ndice seleccionado con teclado
        let lastQuery = '';
        const MIN = 2;
        const ENDPOINT = (q)=> `/modulo1/api/buscar-clientes/?q=${encodeURIComponent(q)}`;

        // Debounce para no ‚Äúgolpear‚Äù el server en cada tecla
        function debounce(fn, ms){
            let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
        }

        function setMenuVisible(v){
            if(v){ $menu.classList.add('show'); $input.setAttribute('aria-expanded','true'); }
            else { $menu.classList.remove('show'); $input.setAttribute('aria-expanded','false'); activeIndex=-1; }
        }

        function renderEmpty(message){
            $menu.innerHTML =
            `<div class="dropdown-item disabled"><small>${message}</small></div>`;
        }

        function highlight(text, q){
            if(!q) return text;
            const re = new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'ig');
            return text.replace(re,'<strong>$1</strong>');
        }

        function renderList(q){
            if(!items.length){
            renderEmpty('Sin resultados');
            return setMenuVisible(true);
            }
            $menu.innerHTML = items.map((c,i)=> `
            <button type="button"
                    class="dropdown-item ${i===activeIndex?'active':''}"
                    role="option"
                    data-index="${i}">
                <div>${highlight(`${c.first_name} ${c.last_name}`, q)} <small>(${c.dni_usuario})</small></div>
            </button>
            `).join('');
            setMenuVisible(true);
        }

        function selectIndex(i){
            const c = items[i];
            if(!c) return;
            $input.value = `${c.first_name} ${c.last_name}`;
            $dni.value   = c.dni_usuario;
            setMenuVisible(false);
            // Envi√° el formulario al seleccionar
            $form.submit();
        }

        const doSearch = debounce(async function(){
            const q = $input.value.trim();
            lastQuery = q;

            if(q.length < MIN){
            setMenuVisible(false);
            return;
            }

            // Estado "buscando‚Ä¶"
            $menu.innerHTML = `<div class="dropdown-item disabled"><small>Buscando‚Ä¶</small></div>`;
            setMenuVisible(true);

            try{
            const res = await fetch(ENDPOINT(q));
            const data = await res.json();
            items = Array.isArray(data) ? data : [];
            activeIndex = -1;
            renderList(q);
            }catch(e){
            items = [];
            renderEmpty('Error al buscar');
            setMenuVisible(true);
            }
        }, 220);

        // Eventos
        $input.addEventListener('input', doSearch);

        // Click en un √≠tem
        $menu.addEventListener('click', (e)=>{
            const btn = e.target.closest('.dropdown-item');
            if(!btn) return;
            const i = Number(btn.dataset.index);
            selectIndex(i);
        });

        // Teclado
        $input.addEventListener('keydown', (e)=>{
            if(!$menu.classList.contains('show')) return;

            if(e.key === 'ArrowDown'){
            e.preventDefault();
            activeIndex = (activeIndex + 1) % Math.max(items.length, 1);
            renderList(lastQuery);
            ensureVisible(activeIndex);
            }else if(e.key === 'ArrowUp'){
            e.preventDefault();
            activeIndex = (activeIndex - 1 + Math.max(items.length, 1)) % Math.max(items.length, 1);
            renderList(lastQuery);
            ensureVisible(activeIndex);
            }else if(e.key === 'Enter'){
            if(activeIndex >= 0){ e.preventDefault(); selectIndex(activeIndex); }
            }else if(e.key === 'Escape'){
            setMenuVisible(false);
            }
        });

        function ensureVisible(idx){
            const el = $menu.querySelector(`[data-index="${idx}"]`);
            if(el){
            const menuRect = $menu.getBoundingClientRect();
            const elRect   = el.getBoundingClientRect();
            if(elRect.bottom > menuRect.bottom) $menu.scrollTop += (elRect.bottom - menuRect.bottom);
            if(elRect.top < menuRect.top)       $menu.scrollTop -= (menuRect.top - elRect.top);
            }
        }

        // Cerrar si se hace click afuera
        document.addEventListener('click', (e)=>{
            if(!$form.contains(e.target)) setMenuVisible(false);
        });
        })();
    </script>
   
    <!-- Fin Buscar Clientes------------------------------------------------------- -->

    <!-- Mostrar datos de Clientes------------------------------------------------------- -->
    <hr>
    <div style="display: flex; gap: 20px; justify-content: flex-start;">
        <!-- Primera columna -->
        <div style="flex: 1; max-width: 200px;">
            <p style="margin: 2px 0; font-size: 12px;"><strong>Nombre:</strong> {{ first_name }}</p>
            <p style="margin: 2px 0; font-size: 12px;"><strong>Apellido:</strong> {{ last_name }}</p>
        </div>
        <!-- Segunda columna -->
        <div style="flex: 1; max-width: 200px;">
            <p style="margin: 2px 0; font-size: 12px;"><strong>Cel:</strong> {{ tel1_usuario }}</p>
            <p style="margin: 2px 0; font-size: 12px;"><strong>Dom:</strong> <span id="domicilio_usuario">{{ domicilio_usuario }}</span></p>
        </div>
        <!-- Terncera columna -->
        <div style="flex:1;max-width:200px;">
            <p style="margin:2px 0;font-size:12px;"><strong>CUIL:</strong> <span id="cuil_usuario">{{ cuil }}</span></p>
            <p style="margin:2px 0;font-size:12px;"><strong>IVA:</strong> <span id="iva_usuario">{{ iva }}</span></p>
        </div>
    </div>

        <!-- Fin datos de Clientes------------------------------------------------------- -->
        <hr>
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body py-3">
                <form id="producto-form">
                {% csrf_token %}

                <div class="row g-3 align-items-end">
                    <!-- N¬∞ Producto (mismo ancho que Nombre) -->
                    <div class="col-12 col-md-5">
                    <label for="numero_producto" class="form-label mb-1">N¬∞ Producto</label>
                    <input
                        type="text"
                        id="numero_producto"
                        name="numero_producto"
                        class="form-control form-control-sm"
                        placeholder="Ej: 10234"
                        inputmode="numeric"
                    />
                    </div>

                    <!-- Bot√≥n (no afecta el ancho de las cajas) -->
                    <div class="col-12 col-md-2 d-grid">
                    <button
                        type="button"
                        id="buscar-mercaderia-numero"
                        class="btn btn-success btn-sm"
                        title="Buscar por n√∫mero"
                    >
                        Buscar
                    </button>
                    </div>

                    <!-- Nombre Producto (mismo ancho que N¬∞) -->
                    <div class="col-12 col-md-5 position-relative">
                    <label for="nombre_producto" class="form-label mb-1">Nombre Producto</label>
                    <input
                        type="text"
                        id="nombre_producto"
                        name="nombre_producto"
                        class="form-control form-control-sm"
                        placeholder="Ej: Remera algod√≥n"
                        autocomplete="off"
                    />
                    <ul id="sugerencias" class="list-group sugerencias-dropdown"></ul>
                    </div>
                </div>
                </form>
            </div>
            </div>


                <!-- Bot√≥n por nombre en desktop (alineado a la derecha) -->
                <div class="col-md-2 d-none d-md-flex align-items-end justify-content-end">
                <button
                    type="button"
                    id="buscar-mercaderia-nombre"
                    class="btn btn-primary btn-sm"
                    title="Buscar por nombre"
                >
                    Buscar
                </button>
                </div>
            </div>
            </form>
        </div>
        </div>
<style>
  /* Igual ancho m√°ximo en desktop; en m√≥vil ocupan 100% */
  @media (min-width: 768px){
    #numero_producto, #nombre_producto { max-width: 540px; }
  }
  .sugerencias-dropdown{ display:none; position:absolute; top:calc(100% + 4px); left:0; right:0; z-index:1050; max-height:260px; overflow:auto; }
</style>
        <hr>
        <style>
            #buscar-mercaderia-nombre {
                display: none;
            }
        </style>

<!----------------------------------------- Tabla de la factura -->
<table class="table table-striped">
    <thead style="font-size: 12px;">
        <tr>
            <th style="color: #0b2c4e;">N¬∞ Producto</th>
            <th style="color: #0b2c4e;">Nombre Producto</th>
            <th style="color: #0b2c4e;">Cantidad</th>
            <th style="color: #0b2c4e;">Precio Unitario</th>
            <th style="color: #0b2c4e;">Importe</th>
            <th style="color: #0b2c4e;">Borrar</th>
        </tr>
    </thead>
    <tbody id="producto-info">
        <!-- Filas din√°micas ser√°n a√±adidas aqu√≠ -->
    </tbody>

    <tfoot style="font-size: 12px;">
        <tr>
            <td colspan="4" class="text-end"><strong>Suma:</strong></td>
            <td id="total-general">$0.00</td>
        </tr>
        <tr>
            <td colspan="4" class="text-end"><strong>Desc. (%):</strong></td>
            <td>
                <input type="number" id="descuento" class="form-control" value="0" min="0" max="100" step="1">
            </td>
        </tr>
        <tr>
            <td colspan="4" class="text-end"><strong>Total:</strong></td>
            <td id="total-con-descuento">$0.00</td>
        </tr>


        <!--/*----------------------------- Metodo Pago */-->
        <!--/* Metodo Pago */-->
        <tr class="table-light align-middle">
        <td colspan="6" class="p-2 pago-cell">
            <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                
            <div class="fw-semibold text-muted">M√©todo de Pago</div>

            <div id="seccion-metodos-pago" class="flex-grow-1">
                {% if metodos_pago %}
                <div class="input-group input-group-sm" style="max-width: 520px;">
                    
                    <select id="metodo-pago" name="metodo_pago" class="form-select form-select-sm" aria-label="Seleccionar m√©todo">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Cuenta Corriente">Cuenta Corriente</option>
                    {% for metodo in metodos_pago %}
                        <option value="{{ metodo.tarjeta_nombre }}">{{ metodo.tarjeta_nombre }}</option>
                    {% endfor %}
                    </select>
                </div>
                
                {% else %}
                    <div class="text-danger">‚ö† No hay m√©todos de pago disponibles.</div>
                {% endif %}
            </div>
            </div>
        </td>

        </tr>
        <style>
            /* Evitar que el select se ‚Äúcorte‚Äù dentro del tfoot */
            .pago-cell { overflow: visible; }
            .table tfoot td { overflow: visible; }

            /* Que el select crezca y en mobile ocupe todo */
            #metodo-pago { min-width: 220px; }
            @media (max-width: 768px){
                .pago-cell .input-group { max-width: 100% !important; }
                #metodo-pago { width: 100%; }
            }
        </style>
        <!---- Modal para Cuenta Corriente ---------------------------------------->
            <div class="modal fade" id="creditoModal" tabindex="-1" aria-labelledby="creditoModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content shadow">

                        <div class="modal-header bg-light border-bottom d-flex flex-column align-items-start">
                            <small id="metodoPagoSeleccionado" class="text-muted fw-semibold mb-1" style="font-size: 14px;"></small>
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <h5 class="modal-title" id="creditoModalLabel" style="color: #0b2c4e; font-weight: bold;">Registrar Cobro</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                        </div>
                        <div class="modal-body">
                        <form id="creditoForm" class="needs-validation" novalidate>
                
                            <!-- N√∫mero de tarjeta -->
                            <div class="mb-3">
                            <label for="tarjeta_numero_credito" class="form-label text-danger fw-semibold">N√∫mero Tarjeta:</label>
                            <input type="text" id="tarjeta_numero_credito" name="tarjeta_numero" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de tarjeta" required>
                            </div>
                            
                            <!-- N√∫mero de ticket -->
                            <div class="mb-3">
                            <label for="numero_ticket_credito" class="form-label text-danger fw-semibold">N√∫mero Ticket:</label>
                            <input type="text" id="numero_ticket_credito" name="numero_tiket" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de Ticket" required>
                            </div>
                
                            <!-- ID oculto de la factura -->
                            <input type="hidden" id="modal-factura-id" name="factura_id" value="">
                
                            <!-- Suma -->
                            <div class="mb-2">
                            <label class="form-label fw-semibold">Suma: <span class="text-success" id="suma">$0.00</span></label>
                            </div>
                
                            <!-- Inter√©s -->
                            <div class="mb-3">
                            <label for="interes" class="form-label text-primary fw-semibold">Ingresar el Inter√©s (%)</label>
                            <input type="number" id="interes" name="interes" step="0.01" class="form-control" required oninput="calcularInteres()">
                            </div>
                
                            <!-- Inter√©s Calculado -->
                            <div class="mb-2">
                            <label class="form-label">Suma * Int / 100: <span id="interesCalculado" class="text-muted">$0.00</span></label>
                            </div>
                
                            <!-- Total con Inter√©s -->
                            <div class="mb-2">
                            <label class="form-label">Suma + Inter√©s: <span id="sumaMasInteres" class="text-success">$0.00</span></label>
                            <input type="hidden" id="totalConInteres" name="total_con_interes">
                            </div>
                
                            <!-- Cuotas -->
                            <div class="mb-3">
                            <label for="cuotas" class="form-label text-primary fw-semibold">Cantidad de Cuotas</label>
                            <input type="number" id="cuotas" name="cuotas" min="1" class="form-control" required oninput="calcularCuotaMensual()">
                            </div>
                
                            <!-- Cuota mensual -->
                            <div class="mb-3">
                            <label class="form-label">Cuota Mensual: <span id="cuotaMensual" class="text-success">$0.00</span></label>
                            </div>
                
                            <!-- Bot√≥n -->
                            <div class="text-end">
                            <button type="button" id="guardarCredito" class="btn btn-primary w-100">Guardar Cr√©dito</button>
                            </div>
                        </form>
                        </div>
                    </div>
                    </div>
            </div>
            <!--------------------- FIN DEL MODAL DE CREDITO  ------------------------>


            <!--------------------- inicio DEL MODAL DE tarjeta  ------------------------>
                <div class="modal fade" id="modalTarjeta" tabindex="-1" aria-labelledby="modalTarjetaLabel"     aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content shadow">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title" id="modalTarjetaLabel">Cobro con Tarjeta</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formTarjeta">

                        <!-- N√∫mero de tarjeta -->
                        <!-- N√∫mero de tarjeta -->
                            <div class="mb-3">
                            <label for="tarjeta_numero_tarjeta" class="form-label text-danger fw-semibold">N√∫mero Tarjeta:</label>
                            <input type="text" id="tarjeta_numero_tarjeta" name="tarjeta_numero" class="form-control" maxlength="16" placeholder="Ingrese n√∫mero de tarjeta" required>
                            </div>

                        <!-- N√∫mero de Ticket -->
                        <div class="mb-3">
                            <label for="numero_ticket_tarjeta" class="form-label">N¬∞ Ticket</label>
                            <input type="text" class="form-control" id="numero_ticket_tarjeta" required>
                        </div>

                        <!-- Lista de Cuotas -->
                        <div class="mb-3">
                            <label class="form-label">Seleccion√° una opci√≥n de Cuota</label>
                            <div id="lista-cuotas" class="list-group" style="max-height: 200px; overflow-y: auto;">
                            <!-- Se cargan din√°micamente -->
                            </div>

                            <!-- Inputs ocultos para guardar selecci√≥n -->
                            <input type="hidden" id="cuotas_tarjeta">
                            <input type="hidden" id="interes_tarjeta">
                        </div>

                        <!-- Cuota mensual -->
                        <div class="mb-3">
                            <label class="form-label">Cuota Mensual</label>
                            <input type="text" id="cuota_mensual" class="form-control" readonly>
                        </div>

                        <!-- Bot√≥n -->
                        <div class="text-end">
                            <button type="button" id="guardarTarjeta" class="btn btn-primary w-100">Guardar Tarjeta</button>
                        </div>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
        <!--------------------- FIN DEL MODAL DE Tarjeta  ------------------------>
        
        </tr>


       <td colspan="6" class="p-3">
        <button
            type="button"
            id="guardar"
            class="btn btn-primary btn-lg px-5 fw-semibold d-block mx-auto"
            style="min-width:220px;"
            onclick="redirigirGuardar('{{ factura.id }}')">
            Aceptar
        </button>
        </td>
    </tfoot>
</table>


<!-- Script para manejar las redirecciones -->
<!-- Script para manejar c√°lculos en el modal -->
<script>
    function actualizarSuma() {
        let totalConDescuentoElemento = document.getElementById("total-con-descuento");
        if (!totalConDescuentoElemento) {
            console.error("‚ùå No se encontr√≥ el elemento 'total-con-descuento'.");
            return;
        }
        let totalConDescuentoTexto = totalConDescuentoElemento.textContent.replace('$', '').trim();
        let totalConDescuento = parseFloat(totalConDescuentoTexto) || 0;

        let sumaElemento = document.getElementById("suma");
        if (!sumaElemento) {
            console.error("‚ùå No se encontr√≥ el elemento 'suma'.");
            return;
        }
        sumaElemento.textContent = totalConDescuento.toFixed(2);

        console.log("üîÑ Suma actualizada desde Total con Descuento:", totalConDescuento);

        calcularInteres();
    }

    function calcularInteres() {
        let suma = parseFloat(document.getElementById("suma").textContent) || 0;
        let interes = parseFloat(document.getElementById("interes").value) || 0;

        let interesCalculado = (suma * interes) / 100;
        document.getElementById("interesCalculado").textContent = interesCalculado.toFixed(2);

        calcularSumaMasInteres(suma, interesCalculado);
    }

    function calcularSumaMasInteres(suma, interesCalculado) {
        let sumaMasInteres = suma + interesCalculado;

        document.getElementById("sumaMasInteres").textContent = sumaMasInteres.toFixed(2);
        document.getElementById("totalConInteres").value = sumaMasInteres.toFixed(2);

        console.log("üìå total_con_interes actualizado:", sumaMasInteres);
    }

    function calcularCuotaMensual() {
        let sumaMasInteres = parseFloat(document.getElementById("sumaMasInteres").textContent) || 0;
        let cuotas = parseInt(document.getElementById("cuotas").value) || 1;

        let cuotaMensual = sumaMasInteres / cuotas;
        document.getElementById("cuotaMensual").textContent = cuotaMensual.toFixed(2);

        console.log("üí∞ Cuota Mensual calculada:", cuotaMensual);
    }

    document.addEventListener("DOMContentLoaded", function () {
        // ‚úÖ Asegurar que la suma se actualiza al abrir el modal
        let creditoModal = document.getElementById('creditoModal');
        if (creditoModal) {
            creditoModal.addEventListener('show.bs.modal', function () {
                actualizarSuma();
            });
        }

        // ‚úÖ Asegurar que la suma se actualiza cuando cambia el descuento
        let descuentoInput = document.getElementById("descuento");
        if (descuentoInput) {
            descuentoInput.addEventListener("input", function () {
                calcularTotalGeneral();
                actualizarSuma();
            });
        }

        // ‚úÖ Vincular el evento `oninput` al campo de cuotas
        let cuotasInput = document.getElementById("cuotas");
        if (cuotasInput) {
            cuotasInput.addEventListener("input", function () {
                calcularCuotaMensual();
                console.log("üìå Evento detectado en Cant Cuot, ejecutando calcularCuotaMensual()");
            });
        } else {
            console.error("‚ùå No se encontr√≥ el elemento 'cuotas'.");
        }

        // ‚úÖ Asegurar que la suma se actualiza al cargar la p√°gina
        actualizarSuma();
    });
</script>




<!-- Script para buscar, manejar c√°lculos y eliminar filas 88888888888-->
    <script>
    function agregarProductoATabla(data) {
        if (data.error) {
            alert(data.error);
        } else {
            const tableBody = document.getElementById('producto-info');
            const newRow = document.createElement('tr');

            // Crear celdas para la fila
            const cellNumero = document.createElement('td');
            const cellNombre = document.createElement('td');
            const cellCantidadVendida = document.createElement('td'); // Cambiado
            const cellPrecioUnitario = document.createElement('td'); // Cambiado
            const cellSubtotal = document.createElement('td'); // Cambiado
            const cellEliminar = document.createElement('td');

            // Validar y asignar valores a las celdas
            cellNumero.textContent = data.numero_producto ? data.numero_producto : 'N/A';
            cellNombre.textContent = data.nombre_producto ? data.nombre_producto : 'N/A';

            const precioUnitario = parseFloat(data.precio) || 0;

            // Campo de entrada para el precio unitario
            const inputPrecioUnitario = document.createElement('input'); // Cambiado
            inputPrecioUnitario.type = 'number';
            inputPrecioUnitario.value = precioUnitario.toFixed(2);
            inputPrecioUnitario.min = 0;
            inputPrecioUnitario.className = 'form-control';
            inputPrecioUnitario.disabled = true; // No editable
            cellPrecioUnitario.appendChild(inputPrecioUnitario);

            // Campo de entrada para la cantidad vendida
            const inputCantidadVendida = document.createElement('input'); // Cambiado
            inputCantidadVendida.type = 'number';
            inputCantidadVendida.value = 1; // Cantidad inicial
            inputCantidadVendida.min = 0.01;
            inputCantidadVendida.step = 0.01;
            inputCantidadVendida.className = 'form-control';
            inputCantidadVendida.addEventListener('input', function () {
                const subtotal = parseFloat(inputCantidadVendida.value) * parseFloat(inputPrecioUnitario.value || 0);
                inputSubtotal.value = subtotal.toFixed(2);
                calcularTotalGeneral();
            });
            cellCantidadVendida.appendChild(inputCantidadVendida);

            // Campo de entrada para el subtotal
            const inputSubtotal = document.createElement('input'); // Cambiado
            inputSubtotal.type = 'number';
            inputSubtotal.value = (precioUnitario * parseFloat(inputCantidadVendida.value)).toFixed(2); // Importe inicial
            inputSubtotal.min = 0;
            inputSubtotal.step = 0.01;
            inputSubtotal.className = 'form-control';
            inputSubtotal.addEventListener('input', function () {
                const nuevoSubtotal = parseFloat(inputSubtotal.value) || 0;
                const nuevaCantidad = nuevoSubtotal > 0 ? (nuevoSubtotal / precioUnitario).toFixed(2) : 0;
                inputCantidadVendida.value = nuevaCantidad; // Ajustar cantidad autom√°ticamente
                calcularTotalGeneral();
            });
            cellSubtotal.appendChild(inputSubtotal);

            // Bot√≥n para eliminar la fila
            const btnEliminar = document.createElement('button');
            btnEliminar.className = 'btn btn-danger btn-sm';
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.addEventListener('click', function () {
                newRow.remove(); // Eliminar la fila
                calcularTotalGeneral(); // Recalcular el total general
            });
            cellEliminar.appendChild(btnEliminar);

            // A√±adir celdas a la fila
            newRow.appendChild(cellNumero);
            newRow.appendChild(cellNombre);
            newRow.appendChild(cellCantidadVendida);
            newRow.appendChild(cellPrecioUnitario);
            newRow.appendChild(cellSubtotal);
            newRow.appendChild(cellEliminar);

            // A√±adir fila a la tabla
            tableBody.appendChild(newRow);

            // Recalcular el total general
            calcularTotalGeneral();
        }
        }

        // Funci√≥n para buscar por n√∫mero de producto
        document.getElementById('buscar-mercaderia-numero').addEventListener('click', function () {
                const numeroProducto = document.getElementById('numero_producto').value;

                fetch(`/modulo1/buscar-mercaderia/?numero_producto=${numeroProducto}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Error al buscar la mercader√≠a');
                        return response.json();
                    })
                    .then(data => agregarProductoATabla(data))
                    .catch(error => {
                        console.error(error);
                        alert('Ocurri√≥ un error al buscar la mercader√≠a por n√∫mero.');
                    });
            });


        // Funci√≥n para buscar por nombre de producto
        document.getElementById('buscar-mercaderia-nombre').addEventListener('click', function () {
                const nombreProducto = document.getElementById('nombre_producto').value;

                fetch(`/modulo1/buscar-mercaderia/?nombre_producto=${encodeURIComponent(nombreProducto)}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Error al buscar la mercader√≠a');
                        return response.json();
                    })
                    .then(data => agregarProductoATabla(data))
                    .catch(error => {
                        console.error(error);
                        alert('Ocurri√≥ un error al buscar la mercader√≠a por nombre.');
                    });
            });


            // Funci√≥n para calcular el total general y con descuento
            function calcularTotalGeneral() {
                const rows = document.querySelectorAll('#producto-info tr');
                let totalGeneral = 0;

                rows.forEach(row => {
                    const importeInput = row.cells[4].querySelector('input'); // Obtener el <input> del importe
                    if (importeInput) {
                        totalGeneral += parseFloat(importeInput.value || 0); // Sumar el valor del input
                    }
                });

        document.getElementById('total-general').textContent = `$${totalGeneral.toFixed(2)}`;
        const descuentoPorcentaje = parseFloat(document.getElementById('descuento').value) || 0;
        const totalConDescuento = totalGeneral - (totalGeneral * (descuentoPorcentaje / 100));
        document.getElementById('total-con-descuento').textContent = `$${totalConDescuento.toFixed(2)}`;
        }

        document.getElementById('descuento').addEventListener('input', calcularTotalGeneral);
    </script>



<script>
// Por Nombre de producto
document.getElementById('nombre_producto').addEventListener('input', function () {
    const query = this.value;
    const sugerencias = document.getElementById('sugerencias');

    if (query.trim()) {
        fetch(`/modulo1/buscar-mercaderia/?nombre_producto=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                sugerencias.innerHTML = '';
                sugerencias.style.display = 'block';

                if (data.length === 0) {
                    sugerencias.style.display = 'none';
                } else {
                    data.forEach(producto => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item list-group-item-action';
                        item.textContent = producto.nombre_producto;

                        // Guardar datos adicionales en atributos data
                        item.setAttribute('data-numero-producto', producto.numero_producto);
                        item.setAttribute('data-precio', producto.precio);

                        item.addEventListener('click', function () {
                            document.getElementById('nombre_producto').value = producto.nombre_producto;
                            document.getElementById('numero_producto').value = producto.numero_producto;

                            // Actualizar tabla con datos del producto seleccionado
                            agregarProductoATabla({
                                numero_producto: producto.numero_producto,
                                nombre_producto: producto.nombre_producto,
                                precio: producto.precio,
                            });

                            sugerencias.style.display = 'none';
                        });

                        sugerencias.appendChild(item);
                    });
                }
            })
            .catch(error => {
                console.error('Error al buscar sugerencias:', error);
                sugerencias.style.display = 'none';
            });
    } else {
        sugerencias.style.display = 'none';
    }
});

// --------GUARDAR producto--------------------------------GUARDAR producto
// --------GUARDAR producto--------------------------------GUARDAR producto
// --------GUARDAR producto--------------------------------GUARDAR producto

document.getElementById('guardar').addEventListener('click', function () {
   const guardarBtn = document.getElementById('guardar');
    if (guardarBtn.disabled) return;

    guardarBtn.disabled = true;
    guardarBtn.textContent = "Guardando...";

    const fecha = new Date().toISOString().split('T')[0];
    const dniCliente = document.getElementById('dni_cliente_hidden')?.value.trim() || '';
    const nombreCliente = document.querySelector('p:nth-of-type(1) strong')?.nextSibling?.textContent.trim() || '';
    const apellidoCliente = document.querySelector('p:nth-of-type(2) strong')?.nextSibling?.textContent.trim() || '';
    const domicilioFactura = document.getElementById("domicilio_usuario")?.textContent?.trim() || '';
    const cuilFactura = document.getElementById("cuil_usuario")?.textContent?.trim() || '';
    const ivaFactura = document.getElementById("iva_usuario")?.textContent?.trim() || '';

    const metodoPago = document.getElementById('metodo-pago').value || '';
    const total = parseFloat(document.getElementById('total-general').textContent.replace('$', '')) || 0;
    const descuento = parseFloat(document.getElementById('descuento').value) || 0;
    const totalConDescuento = total - (total * (descuento / 100));

    
    const detalleProductos = [];
    document.querySelectorAll('#producto-info tr').forEach(row => {
        const numeroProducto = row.cells[0]?.textContent || '';
        const nombreProducto = row.cells[1]?.textContent || '';
        const cantidadVendida = parseFloat(row.cells[2]?.querySelector('input')?.value || 0);
        const precioUnitario = parseFloat(row.cells[3]?.querySelector('input')?.value || 0);
        const subtotal = parseFloat(row.cells[4]?.querySelector('input')?.value || 0);

        if (numeroProducto && nombreProducto && cantidadVendida && precioUnitario && subtotal) {
            detalleProductos.push({
                numero_producto: numeroProducto,
                nombre_producto: nombreProducto,
                cantidad_vendida: cantidadVendida,
                precio_unitario: precioUnitario,
                subtotal: subtotal,
            });
        }
    });

    const payload = {
        fecha: fecha,
        dni_cliente: dniCliente,
        nombre_cliente: nombreCliente,
        apellido_cliente: apellidoCliente,
        domicilio_factura: domicilioFactura,
        cuil: cuilFactura,
        iva: ivaFactura,
        metodo_pago: metodoPago,
        tarjeta_nombre: tarjetaNombre,  // ‚úÖ Se env√≠a solo si es necesario
        tarjeta_numero: tarjetaNumero,  // ‚úÖ Se env√≠a solo si es necesario
        total: total,
        descuento: descuento,
        total_con_descuento: totalConDescuento,
        detalle_productos: detalleProductos,
    };

    console.log("üì® Enviando datos al backend:", payload);

    fetch('/modulo1/guardar-prueba/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(payload),
   })

    .then(response => response.json())
    .then(data => {
        if (data.redirect) {
            console.log("üîÑ Redirigiendo a:", data.redirect);
            window.location.href = data.redirect;
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("‚ùå Error en la petici√≥n:", error);
        alert("Ocurri√≥ un error al guardar la factura.");
    });
});

//------------------- Funci√≥n para limpiar el formulario ------- despu√©s de guardar
//-------------------- Funci√≥n para limpiar el formulario despu√©s de guardar

function limpiarFormulario() {
    // Limpiar todos los campos del formulario
    document.getElementById('dni_cliente').value = '';
    document.querySelector('p:nth-of-type(1) strong').nextSibling.textContent = '';
    document.querySelector('p:nth-of-type(2) strong').nextSibling.textContent = '';
    document.querySelector('p:nth-of-type(3) strong').nextSibling.textContent = '';
    document.getElementById('numero_producto').value = '';
    document.getElementById('nombre_producto').value = '';
    document.getElementById('producto-info').innerHTML = '';
    document.getElementById('total-general').textContent = '$0.00';
    document.getElementById('descuento').value = 0;
    document.getElementById('total-con-descuento').textContent = '$0.00';
    document.getElementById('metodo-pago').value = 'Efectivo';
    // Opcional: reiniciar el n√∫mero de factura
    document.getElementById('numero_factura').textContent = '00000';
    }
</script>

<!------------------------------------------------------------------------->
<!-- Script para manejar el m√©todo de pago y mostrar el modal de cr√©dito -->
<!-- Script para manejar el m√©todo de pago y mostrar el modal de cr√©dito -->
<!-- Script para manejar el m√©todo de pago y mostrar el modal de cr√©dito -->

<script>
document.getElementById('metodo-pago').addEventListener('change', function () {
    const metodoPago = this.value;

    if (metodoPago === "Efectivo") {
        guardarFactura("guardar");
    } else if (metodoPago === "Cuenta Corriente") {
        let creditoModal = new bootstrap.Modal(document.getElementById('creditoModal'));
        creditoModal.show();
    } else {
        // Si es tarjeta (cualquier otro m√©todo registrado)
        document.getElementById('modalTarjetaLabel').textContent = `Cobro con: ${metodoPago}`;
        let modalTarjeta = new bootstrap.Modal(document.getElementById('modalTarjeta'));
        modalTarjeta.show();
    }
});


// ‚úÖ Solo guardar si el usuario presiona "Guardar Cr√©dito"
document.getElementById('guardarCredito').addEventListener('click', function () {
    let modalElement = document.getElementById('creditoModal');
    modalElement.dataset.confirmado = "true"; // ‚úÖ Marcamos que el usuario confirm√≥ el pago
    guardarFactura("guardarCredito");
});


// ‚úÖ Bot√≥n de efectivo sigue funcionando normalmente
document.getElementById('guardar').addEventListener('click', function () {
    guardarFactura("guardar");
});


// ‚úÖ ------------ guardar Factura ----------------------------
function guardarFactura(origen) {
    console.log(`üìå Guardando desde: ${origen}`);

    const guardarBtn = document.getElementById('guardar');
    guardarBtn.disabled = true;
    guardarBtn.textContent = "Guardando...";

    const fecha = new Date().toISOString().split('T')[0];
    const dniCliente = document.getElementById('dni_cliente_hidden')?.value.trim() || '';
    const nombreCliente = document.querySelector('p:nth-of-type(1) strong')?.nextSibling?.textContent.trim() || '';
    const apellidoCliente = document.querySelector('p:nth-of-type(2) strong')?.nextSibling?.textContent.trim() || '';
    const domicilioFactura = document.getElementById("domicilio_usuario")?.textContent?.trim() || '';
    const cuilFactura = document.getElementById("cuil_usuario")?.textContent?.trim() || '';
    const ivaFactura = document.getElementById("iva_usuario")?.textContent?.trim() || '';
    // ‚úÖ Capturar el m√©todo de pago seleccionado
    const metodoPago = document.getElementById('metodo-pago')?.value.trim() || '';

    const total = parseFloat(document.getElementById('total-general')?.textContent.replace('$', '').trim()) || 0;
    const descuento = parseFloat(document.getElementById('descuento')?.value.trim()) || 0;
    const totalConDescuento = total - (total * (descuento / 100));

    let tarjetaNombre = '';
    let tarjetaNumero = '';
    let numeroTicket = '';  // ‚úÖ <-- AGREGALO AC√Å
    let interes = 0;
    let cuotas = 1;
    let totalConInteres = totalConDescuento;
    let cuotaMensual = 0;  // ‚úÖ Asegurar que `cuotaMensual` siempre se defina

    // ‚úÖ Si se est√° guardando desde el modal de cr√©dito, capturar los valores correctos
    if (origen === "guardarCredito" || document.getElementById("creditoModal").classList.contains("show")) {
        tarjetaNumero = document.getElementById('tarjeta_numero_credito')?.value.trim() || '';
        tarjetaNombre = metodoPago; 
        numeroTicket = document.getElementById('numero_ticket_credito')?.value.trim() || '';

        // Capturar inter√©s, cuotas y total con inter√©s
        interes = parseFloat(document.getElementById('interes')?.value.trim() || 0);
        cuotas = parseInt(document.getElementById('cuotas')?.value.trim() || 1);
        totalConInteres = parseFloat(document.getElementById('totalConInteres')?.value.trim() || totalConDescuento);
    }

    if (origen === "guardarTarjeta" || document.getElementById("modalTarjeta").classList.contains("show")) {
        tarjetaNumero = document.getElementById('tarjeta_numero_tarjeta')?.value.trim() || '';  // üëà CORREGIDO
        tarjetaNombre = metodoPago;
        numeroTicket = document.getElementById('numero_ticket_tarjeta')?.value.trim() || '';
        cuotas = parseInt(document.getElementById('cuotas_tarjeta')?.value.trim() || 1);
        interes = parseFloat(document.getElementById('interes_tarjeta')?.value.trim() || 0);

        const total = parseFloat(document.getElementById('total-con-descuento').textContent.replace('$', '')) || 0;
        totalConInteres = total + (total * (interes / 100));
        cuotaMensual = (totalConInteres / cuotas).toFixed(2);
    }

    // ‚úÖ Calcular la cuota mensual SIEMPRE (si no se envi√≥ desde el modal)
    cuotaMensual = cuotas > 0 ? (totalConInteres / cuotas).toFixed(2) : 0;

    // ‚úÖ Mostrar en consola los valores capturados para depuraci√≥n
    console.log("üìå M√©todo de pago:", metodoPago);
    console.log("üìå Nombre en tarjeta:", tarjetaNombre);
    console.log("üìå N√∫mero de tarjeta:", tarjetaNumero);
    console.log("üìå Inter√©s (%):", interes);
    console.log("üìå Cuotas:", cuotas);
    console.log("üìå Total con inter√©s:", totalConInteres);
    console.log("üí∞ Cuota Mensual calculada:", cuotaMensual);  // ‚úÖ Depuraci√≥n

    // ‚úÖ Capturar productos agregados en la factura
    const detalleProductos = [];
    document.querySelectorAll('#producto-info tr').forEach(row => {
        const numeroProducto = row.cells[0]?.textContent || '';
        const nombreProducto = row.cells[1]?.textContent || '';
        const cantidadVendida = parseFloat(row.cells[2]?.querySelector('input')?.value || 0);
        const precioUnitario = parseFloat(row.cells[3]?.querySelector('input')?.value || 0);
        const subtotal = parseFloat(row.cells[4]?.querySelector('input')?.value || 0);

        if (numeroProducto && nombreProducto && cantidadVendida && precioUnitario && subtotal) {
            detalleProductos.push({
                numero_producto: numeroProducto,
                nombre_producto: nombreProducto,
                cantidad_vendida: cantidadVendida,
                precio_unitario: precioUnitario,
                subtotal: subtotal,
            });
        }
    });

    // ‚úÖ Crear el objeto a enviar al backend
    const payload = {
        fecha: fecha,
        dni_cliente: dniCliente,
        nombre_cliente: nombreCliente,
        apellido_cliente: apellidoCliente,
        domicilio_factura: domicilioFactura,
        cuil: cuilFactura,
        iva: ivaFactura,
        metodo_pago: metodoPago,
        tarjeta_nombre: tarjetaNombre,
        tarjeta_numero: tarjetaNumero,
        numero_tiket: numeroTicket,  // ‚úÖ AGREGADO
        total: total,
        descuento: descuento,
        total_con_descuento: totalConDescuento,
        interes: interes,  
        cuotas: cuotas,  
        cuota_mensual: cuotaMensual,  // ‚úÖ Se env√≠a SIEMPRE
        total_con_interes: totalConInteres,  
        detalle_productos: detalleProductos,
    };

    console.log("üì® Enviando datos al backend:", JSON.stringify(payload, null, 2));

    // ‚úÖ Enviar la factura al backend
    fetch('/modulo1/guardar-prueba/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
        if (data.redirect) {
            console.log("üîÑ Redirigiendo a:", data.redirect);
            window.location.href = data.redirect;
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error("‚ùå Error en la petici√≥n:", error);
        alert("Ocurri√≥ un error al guardar la factura.");
    })
    .finally(() => {
        guardarBtn.disabled = false;
        guardarBtn.textContent = "Aceptar";
    });
}
</script>


<script>
// Al cambiar el m√©todo de pago
document.getElementById('metodo-pago').addEventListener('change', function () {
    const metodoPago = this.value;

    // Si es efectivo ‚Üí guardar directo
    if (metodoPago === "Efectivo") {
        guardarFactura("guardar");
        return;
    }


// Si es Cuenta Corriente ‚Üí abrir modal cl√°sico
    if (metodoPago === "Cuenta Corriente") {
        new bootstrap.Modal(document.getElementById('creditoModal')).show();
        return;
    }



// Si es tarjeta ‚Üí abrir el nuevo modal y cargar cuotas
document.getElementById('modalTarjetaLabel').textContent = `Cobro con: ${metodoPago}`;
    const modalTarjeta = new bootstrap.Modal(document.getElementById('modalTarjeta'));
    modalTarjeta.show();

    // Traer cuotas desde backend
    fetch(`/modulo1/api/cuotas/${encodeURIComponent(metodoPago)}/`)
        .then(res => res.json())
        .then(data => {
            const lista = document.getElementById('lista-cuotas');
            lista.innerHTML = '';

            if (data.length === 0) {
                lista.innerHTML = '<div class="text-danger">‚ö† No hay cuotas disponibles para esta tarjeta.</div>';
                return;
            }


        // Reemplaz√° esta parte del c√≥digo dentro del fetch de cuotas
        data.forEach(item => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.textContent = `${item.cuotas} cuota(s) - ${item.interes}% inter√©s`;

            btn.addEventListener('click', () => {
                // ‚úÖ Guardar valores en inputs ocultos
                document.getElementById('cuotas_tarjeta').value = item.cuotas;
                document.getElementById('interes_tarjeta').value = item.interes;

                // ‚úÖ Calcular cuota mensual
                const total = parseFloat(document.getElementById('total-con-descuento').textContent.replace('$', '')) || 0;
                const totalConInteres = total + (total * (item.interes / 100));
                const cuotaMensual = totalConInteres / item.cuotas;

                document.getElementById('cuota_mensual').value = `$${cuotaMensual.toFixed(2)}`;

                // ‚úÖ Activar bot√≥n visualmente
                document.querySelectorAll('#lista-cuotas .list-group-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');

                console.log("‚úÖ Cuota seleccionada correctamente:", item);
            });

            lista.appendChild(btn);
        });




        })
        .catch(err => {
            console.error("Error al cargar cuotas:", err);
            document.getElementById('lista-cuotas').innerHTML = '<div class="text-danger">Error al obtener cuotas.</div>';
        });
});
</script>



<script>
document.getElementById('guardarTarjeta').addEventListener('click', function () {
    const tarjetaNumeroInput = document.getElementById('tarjeta_numero_tarjeta');  // üëà CAMBIADO
    const ticketInput = document.getElementById('numero_ticket_tarjeta');
    const cuotasInput = document.getElementById('cuotas_tarjeta');
    const interesInput = document.getElementById('interes_tarjeta');

    const tarjetaNumero = tarjetaNumeroInput?.value.trim() || '';
    const ticketNumero = ticketInput?.value.trim() || '';
    const cuotasStr = cuotasInput?.value.trim() || '';
    const interesStr = interesInput?.value.trim() || '';

    if (!tarjetaNumero || !ticketNumero || !cuotasStr || !interesStr) {
        alert("‚ö† Por favor, complet√° todos los campos y seleccion√° una cuota v√°lida.");
        return;
    }

    const cuotas = parseInt(cuotasStr);
    const interes = parseFloat(interesStr);

    if (isNaN(cuotas) || isNaN(interes) || cuotas <= 0 || interes < 0) {
        alert("‚ö† Los datos de la cuota son inv√°lidos. Por favor, volv√© a seleccionar.");
        return;
    }
    const totalBase = parseFloat(document.getElementById('total-con-descuento')?.textContent.replace('$', '').trim()) || 0;
    const totalConInteres = totalBase + (totalBase * (interes / 100));
    const cuotaMensual = (totalConInteres / cuotas).toFixed(2);

    document.getElementById('cuota_mensual').value = `$${cuotaMensual}`;

    guardarFactura("guardarTarjeta");
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectMetodo = document.getElementById('metodo-pago');
    const seccionPago = document.getElementById('seccion-metodos-pago');

    if (selectMetodo) {
        selectMetodo.addEventListener('change', function () {
            const valor = this.value;

            if (valor === "Cuenta Corriente") {
                seccionPago.style.display = 'none';
                new bootstrap.Modal(document.getElementById('creditoModal')).show();
            } else if (valor !== "Efectivo") {
                seccionPago.style.display = 'none';
                new bootstrap.Modal(document.getElementById('modalTarjeta')).show();
            }
            // Si es "Efectivo", se sigue con el flujo normal
        });
    }

    // Cuando se cierra cualquier modal ‚Üí volver a mostrar la selecci√≥n
    ['creditoModal', 'modalTarjeta'].forEach(function (id) {
        const modalEl = document.getElementById(id);
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', function () {
                seccionPago.style.display = 'block';
                selectMetodo.value = ""; // Limpiamos selecci√≥n para evitar que se dispare de nuevo
            });
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selectMetodo = document.getElementById('metodo-pago');
    const seccionPago = document.getElementById('seccion-metodos-pago');

    // Evento al cambiar el m√©todo de pago
    if (selectMetodo) {
        selectMetodo.addEventListener('change', function () {
            const valor = this.value;

            if (valor === "Cuenta Corriente") {
                seccionPago.style.display = 'none';
                const modalCredito = new bootstrap.Modal(document.getElementById('creditoModal'), {
                    backdrop: 'static',
                    keyboard: true
                });
                modalCredito.show();
            } else if (valor !== "Efectivo") {
                seccionPago.style.display = 'none';
                const modalTarjeta = new bootstrap.Modal(document.getElementById('modalTarjeta'), {
                    backdrop: 'static',
                    keyboard: true
                });
                modalTarjeta.show();
            }
            // Efectivo no abre modal
        });
    }

    // Cuando se cierra cualquier modal ‚Üí volver a mostrar la selecci√≥n
    ['creditoModal', 'modalTarjeta'].forEach(function (id) {
        const modalEl = document.getElementById(id);
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', function () {
                seccionPago.style.display = 'block';
                selectMetodo.value = ""; // Limpiar la selecci√≥n para evitar loops
                document.body.classList.remove('modal-open'); // Forzar quitar clase si qued√≥
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(b => b.remove()); // Eliminar manualmente si qued√≥
            });
        }
    });
});
</script>


</div> 
{% endblock %}
